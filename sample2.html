<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Timer Manager</title>
  <style>
:root {
  --bg-color: #121212;
  --card-color: #1f1f1f;
  --input-bg: #2b2b2b;
  --text-color: #f5f5f5;
  --accent-color: #4caf50;
  --danger-color: #f44336;
  --muted-text: #888888;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  --font-main: 'Segoe UI', Roboto, sans-serif;
}

:root {
  --accent-color: #4caf50;
  --danger-color: #ef554a;
  --font-main: 'Segoe UI', Roboto, sans-serif;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

/* Default to dark mode */
body.dark-mode {
  --bg-color: #121212;
  --card-color: #1f1f1f;
  --input-bg: #2b2b2b;
  --text-color: #f5f5f5;
  --muted-text: #888888;
}

body.light-mode {
  --bg-color: #e0dddd;
  --card-color: #f0f0f0;
  --input-bg: #ffffff;
  --text-color: #000000;
  --muted-text: #666666;
}

body {
  margin: 0;
  font-family: var(--font-main);
  background-color: var(--bg-color);
  color: var(--text-color);
  display: flex;
  justify-content: center;
  padding: 1rem;
}

.container {
  max-width: 500px;
  width: 100%;
  padding-bottom: 2rem;
}

h1 {
  text-align: center;
  margin-bottom: 1.2rem;
  font-size: 2.2rem;
  font-weight: 600;
  color: var(--accent-color);
  letter-spacing: 0.5px;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  background-color: var(--card-color);
  padding: 1.2rem;
  border-radius: 14px;
  box-shadow: var(--shadow);
  margin-bottom: 2rem;
}

input,
button {
  padding: 0.65rem;
  font-size: 1rem;
  border-radius: 6px;
  border: none;
  outline: none;
  transition: all 0.25s ease;
}

input {
  background-color: var(--input-bg);
  color: var(--text-color);
}

input::placeholder {
  color: var(--muted-text);
}

button {
  background-color: var(--accent-color);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

button:hover {
  opacity: 0.95;
  transform: scale(1.03);
}

.task {
  background-color: var(--card-color);
  padding: 1rem;
  margin-bottom: 1.2rem;
  border-radius: 12px;
  box-shadow: var(--shadow);
  transition: transform 0.2s ease-in-out;
}

.task:hover {
  transform: scale(1.01);
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.6rem;
}

.task-header strong {
  font-size: 1.15rem;
  color: var(--accent-color);
}

.task-time {
  font-size: 0.9rem;
  color: var(--muted-text);
  margin: 0.2rem 0;
}

.buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.6rem;
}

.buttons button {
  flex: 1;
  min-width: 30%;
}

.danger {
  background-color: var(--danger-color);
}

.alert-input-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.5rem;
  padding: 0.3rem 0;
  border-bottom: 1px solid #333;
}

.alert-input-row input {
  background-color: var(--input-bg);
  flex: 1;
}

.alert-input-row button {
  padding: 0.3rem 0.5rem;
  background: transparent;
  font-size: 1.2rem;
}

.dark-toggle {
  position: absolute;
  top: 12px;
  right: 12px;
}

.dark-toggle button {
  background-color: transparent;
  color: var(--text-color);
  border: 1px solid var(--card-color);
  font-size: 1.3rem;
  padding: 0.3rem 0.6rem;
  border-radius: 8px;
  transition: background-color 0.3s;
}

.dark-toggle button:hover {
  background-color: var(--card-color);
}

.hydration-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}

@media screen and (max-width: 600px) {
  .container {
    padding: 0.5rem;
  }

  .hydration-row {
    flex-direction: column;
    align-items: flex-start;
  }

  .buttons button {
    flex: 100%;
  }
}

  </style>
</head>
<body>
  <div class="dark-toggle">
    <button onclick="toggleDarkMode()">🌙</button>
  </div>
  <div class="container">
    <h1>Task Timer</h1>
    <div class="input-group">
      <input type="text" id="taskName" placeholder="Enter task name" />
      <div style="display: flex; gap: 0.5rem">

        <input type="number" id="hours" placeholder="HH" min="0" style="width: 50%" />
        <input type="number" id="minutes" placeholder="MM" min="0" style="width: 50%" />
      </div>

      <!-- <div class="hydration-row">
        <label><input type="checkbox" id="hydrationCheck" /> Hydration Alert</label>
        <input type="number" id="hydrationInterval" placeholder="Interval (min)" min="1" style="width: 50%;" />
      </div> -->

      <div>
        <label>Add Custom Alert:</label>
        <div id="customAlertsContainer"></div>
        <button type="button" onclick="addAlertInput()">➕</button>
      </div>

      <button onclick="addTask()">Add Task</button>
    </div>

    <div id="taskList"></div>
  </div>

  <script>
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const hydrationTimers = {};
    const customAlertTimers = {};

    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function renderTasks() {
      
      const taskList = document.getElementById("taskList");
      taskList.innerHTML = "";
      tasks.forEach((task, i) => {
        const el = document.createElement("div");
        el.className = "task";

        const startTime = task.startTime ? new Date(task.startTime) : null;
        const endTime = task.endTime ? new Date(task.endTime) : null;
        const finalTime = task.startTime
          ? new Date(new Date(task.startTime).getTime() + task.totalDuration)
          : null;

        el.innerHTML = `
          <div class="task-header">
            <strong>${task.name}</strong>
            <button class="danger" onclick="deleteTask(${i})">🗑</button>
          </div>
          <div class="task-time">Start Time: ${startTime ? startTime.toLocaleTimeString() : '-'}</div>
          <div class="task-time">Stop Time: ${endTime ? endTime.toLocaleTimeString() : '-'}</div>
          <div class="task-time">Target Tiime: ${finalTime ? finalTime.toLocaleTimeString() : '-'}</div>
          <div class="task-time">Duration: ${formatDuration(task.totalDuration)}</div>
          <div class="task-time">${task.hydration ? `💧 Hydration every ${task.hydrationInterval} min` : ''}</div>
          ${task.customAlerts && task.customAlerts.length > 0
            ? `<div class="task-time">🔔 Alerts: ${task.customAlerts.map(a => `${a.name} @ ${a.time}min`).join(", ")}</div>`
            : ''}
          <div class="buttons">
            <button onclick="startTimer(${i})">Start</button>
            <button onclick="endTimer(${i})">End</button>
            <button onclick="resetTimer(${i})">Reset</button> 
          </div>
        `;

        taskList.appendChild(el);
      });
    }

function addAlertInput() {
  const container = document.getElementById("customAlertsContainer");

  const alertDiv = document.createElement("div");
  alertDiv.classList.add("alert-input-row");
  alertDiv.style.display = "flex";
  alertDiv.style.alignItems = "center";
  alertDiv.style.justifyContent = "space-between";
  alertDiv.style.marginBottom = "0.5rem";
  alertDiv.style.gap = "0.5rem";
  alertDiv.style.flexWrap = "wrap";

  // Alert Name Input
  const nameInput = document.createElement("input");
  nameInput.type = "text";
  nameInput.placeholder = "Alert Name";
  nameInput.classList.add("alert-input", "alert-name");
  nameInput.style.flex = "2";
  nameInput.style.width = "60%";

  // Alert Time Input
  const timeInput = document.createElement("input");
  timeInput.type = "number";
  timeInput.placeholder = "Time (min)";
  timeInput.min = "1";
  timeInput.classList.add("alert-input", "alert-time");
  timeInput.style.flex = "1";
  timeInput.style.width = "80%";

  // Repeat Checkbox
  const repeatLabel = document.createElement("label");
  repeatLabel.style.display = "flex";
  repeatLabel.style.alignItems = "center";
  repeatLabel.style.gap = "0.2rem";
  repeatLabel.style.flex = "1";
  const repeatCheckbox = document.createElement("input");
  repeatCheckbox.type = "checkbox";
  repeatCheckbox.classList.add("alert-repeat");
  repeatLabel.appendChild(repeatCheckbox);
  repeatLabel.appendChild(document.createTextNode("Repeat"));

  // Delete Button
  const deleteBtn = document.createElement("button");
  deleteBtn.innerHTML = "🗑️";
  deleteBtn.onclick = () => alertDiv.remove();
  deleteBtn.style.cursor = "pointer";
  deleteBtn.style.border = "none";
  deleteBtn.style.background = "transparent";
  deleteBtn.title = "Delete Alert";

  // Add all elements
  alertDiv.appendChild(nameInput);
  alertDiv.appendChild(timeInput);
  alertDiv.appendChild(repeatLabel);
  alertDiv.appendChild(deleteBtn);

  container.appendChild(alertDiv);
}





    function addTask() {
      const name = document.getElementById("taskName").value.trim();
      const hours = parseInt(document.getElementById("hours").value) || 0;
      const minutes = parseInt(document.getElementById("minutes").value) || 0;
    //  const hydration = document.getElementById("hydrationCheck")?.checked || false;
// const hydrationInterval = parseInt(document.getElementById("hydrationInterval")?.value) || 0;

    const alertNameInputs = document.querySelectorAll(".alert-name");
const alertTimeInputs = document.querySelectorAll(".alert-time");
const alertRepeatInputs = document.querySelectorAll(".alert-repeat");

let customAlerts = [];
for (let i = 0; i < alertNameInputs.length; i++) {
  const alertName = alertNameInputs[i].value.trim();
  const alertTime = parseInt(alertTimeInputs[i].value);
  const repeat = alertRepeatInputs[i]?.checked || false;

  if (alertName && !isNaN(alertTime) && alertTime > 0) {
    customAlerts.push({ name: alertName, time: alertTime, repeat });
  }
}


      if (!name || (hours === 0 && minutes === 0)) {
        alert("Enter valid task name and time");
        return;
      }

      tasks.push({
        name,
        hours,
        minutes,
        customAlerts,
        totalDuration: (hours * 60 + minutes) * 60000
      
      });

      saveTasks();
      renderTasks();

      document.getElementById("taskName").value = "";
      document.getElementById("hours").value = "";
      document.getElementById("minutes").value = "";
          
    }

function startTimer(i) {
  console.log("Start button clicked for task", i);
  const task = tasks[i];
  if (task.startTime) return;

  task.startTime = new Date().toISOString();
  task.running = true;

  task.alertTimeouts = [];
  task.alertIntervals = [];

  scheduleCustomAlerts(i);
  notifyWhenDone(i);

  saveTasks();  // <== Save the running state
  renderTasks();
}



    function endTimer(i) {
      if (!tasks[i].startTime) return alert("Please start timer first");
      if (tasks[i].endTime) return alert("Already ended");

      tasks[i].endTime = new Date().toISOString();

      // Clear hydration
      if (hydrationTimers[i]) {
        hydrationTimers[i].forEach(id => clearTimeout(id));
        delete hydrationTimers[i];
      }

      // Clear custom alerts
      if (customAlertTimers[i]) {
        customAlertTimers[i].forEach(id => clearTimeout(id));
        delete customAlertTimers[i];
      }

      saveTasks();
      renderTasks();
    }
function resetTimer(i) {
  const task = tasks[i];
  if (!confirm("Reset this task?")) return;

  // Clear time-up notification
  if (task.timeUpTimeout) {
    clearTimeout(task.timeUpTimeout);
    delete task.timeUpTimeout;
  }

  // Clear custom alert timeouts
  if (customAlertTimers[i]) {
    customAlertTimers[i].forEach(id => clearTimeout(id));
    delete customAlertTimers[i];
  }

  // Clear repeating custom alerts
  if (task.alertIntervals) {
    task.alertIntervals.forEach(id => clearInterval(id));
    task.alertIntervals = [];
  }

  // Clear hydration alerts
  if (hydrationTimers[i]) {
    hydrationTimers[i].forEach(id => clearTimeout(id));
    delete hydrationTimers[i];
  }

  delete task.startTime;
  delete task.endTime;
  task.running = false;
  task.pausedDuration = 0;
  task.lastPausedAt = null;

  saveTasks();
  renderTasks();
}

function formatDuration(ms) {
  const totalMin = Math.floor(ms / 60000);
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return h > 0 ? `${h}h ${m}m` : `${m} min`;
}
function deleteTask(i) {
  const task = tasks[i];

  // Cancel time-up notification
  if (task.timeUpTimeout) {
    clearTimeout(task.timeUpTimeout);
  }

  // Cancel custom alerts (one-time)
  if (customAlertTimers[i]) {
    customAlertTimers[i].forEach(id => clearTimeout(id));
    delete customAlertTimers[i];
  }

  // ✅ Cancel repeating custom alerts
  if (task.alertIntervals) {
    task.alertIntervals.forEach(id => clearInterval(id));
    task.alertIntervals = [];
  }

  // Cancel hydration alerts
  if (hydrationTimers[i]) {
    hydrationTimers[i].forEach(id => clearTimeout(id));
    delete hydrationTimers[i];
  }

  tasks.splice(i, 1);
  saveTasks();
  renderTasks();
}



   function toggleDarkMode() {
  const body = document.body;
  const isDark = body.classList.toggle("dark-mode");

  if (isDark) {
    body.classList.remove("light-mode");
    localStorage.setItem("theme", "dark");
  } else {
    body.classList.add("light-mode");
    localStorage.setItem("theme", "light");
  }
}

function notifyWhenDone(i) {
  const task = tasks[i];
  if (!("Notification" in window)) return;

  Notification.requestPermission().then(permission => {
    if (permission !== "granted") return;

    const timeoutId = setTimeout(() => {
      if (!tasks[i]?.endTime) {
        new Notification(`⏰ Task "${task.name}" time is up!`);
        playBeep();
      }
    }, task.totalDuration);

    task.timeUpTimeout = timeoutId;
  });
}


    function scheduleHydrationNotifications(i) {
      const task = tasks[i];
      const interval = task.hydrationInterval * 60000;
      const count = Math.floor(task.totalDuration / interval);
      hydrationTimers[i] = [];

      for (let n = 1; n <= count; n++) {
        const timeoutId = setTimeout(() => {
          if (tasks[i].endTime) return;
          new Notification(`💧 Time to hydrate during "${task.name}"`);
          playBeep();
        }, n * interval);
        hydrationTimers[i].push(timeoutId);
      }
    }
    function deleteAlert(button) {
  const alertDiv = button.closest('.alert-input-row');
  alertDiv.remove();
}


function scheduleCustomAlerts(index) {
  const task = tasks[index];
  if (!task.customAlerts) return;

  task.customAlerts.forEach(alert => {
    if (alert.repeat) {
      const intervalId = setInterval(() => {
        if (task.running) {
          showNotification("Alert", `${alert.name} for task: ${task.name}`);
          playBeep();
        } else {
          clearInterval(intervalId);
        }
      }, alert.time * 60 * 1000);

      task.alertIntervals.push(intervalId);
    } else {
      const timeoutId = setTimeout(() => {
        if (task.running) {
          showNotification("Custom Alert", `${alert.name} for task: ${task.name}`);
        }
      }, alert.time * 60 * 1000);

      task.alertTimeouts.push(timeoutId);
    }
  });
}


  function showNotification(title, body) {
    if (Notification.permission === "granted") {
      new Notification(title, { body });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification(title, { body });
        }
      });
    }
  }



    function playBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);

      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(800, ctx.currentTime);
      gainNode.gain.setValueAtTime(0.1, ctx.currentTime);

      oscillator.start();
      oscillator.stop(ctx.currentTime + 0.3);
      
    }

    renderTasks();
  </script>
</body>
</html>
